{% extends "base.html" %}
{% load static %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}

{% block title %}Painel do Administrador{% endblock %}

{% block content %}
<div class="admin-container">
    <h2 class="admin-title">Painel do Administrador</h2>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <section class="quick-actions">
        <div class="card" onclick="window.location.href='{% url 'criar_partida' %}'">
            <h2><i class="fas fa-plus-circle"></i> Nova Partida</h2>
            <p>Comece um novo jogo</p>
        </div>
        <div class="card" onclick="window.location.href='{% url 'listar_produtos' %}'">
            <h2><i class="fas fa-box-open"></i> Produtos</h2>
            <p>Gerencie os produtos do jogo</p>
        </div>
        <div class="card">
            <h2><i class="fas fa-chart-line"></i> Relatórios</h2>
            <p>Acesse gráficos e desempenho (futuro)</p>
        </div>
    </section>

    <hr class="section-divider">

    <section class="partidas-management">
        <h3 class="section-title">Gerenciar Partidas</h3>
        
        {% for info in partidas_info %}
            <div class="partida-card">
                <div class="partida-header">
                    <h4>{{ info.partida.nome }}</h4>
                    <span>Criada em: {{ info.partida.data_inicio|date:"d/m/Y H:i" }}</span>
                </div>
                <div class="partida-body">
                    <p><strong>Jogadores:</strong> 
                        {% for jogador_partida in info.jogadores %}
                            {{ jogador_partida.jogador.username }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            Nenhum jogador inscrito.
                        {% endfor %}
                    </p>
                    <p><strong>Status:</strong> <span class="status-{{ info.partida.status|lower }}">{{ info.partida.get_status_display }}</span></p>

                    {% if info.rodada_ativa %}
                        <p><strong>Rodada Ativa: {{ info.rodada_ativa.numero }}</strong></p>
                        <p>
                            <strong>Demanda:</strong> 
                            {% if info.rodada_ativa.produto_demandado %}
                                {{ info.rodada_ativa.quantidade_demandada }}x {{ info.rodada_ativa.produto_demandado.nome }} para {{ info.rodada_ativa.destino_demanda }}
                            {% else %}
                                <span class="text-danger">Aguardando definição</span>
                            {% endif %}
                        </p>
                    {% endif %}
                </div>''
                <div class="partida-actions">
                    {% if info.partida.status != 'FINALIZADA' %}
                        <a href="{% url 'admin_spectator_view' info.partida.id %}" class="btn btn-info">Ver como Espectador</a>
                        
                        {% if info.rodada_ativa %}
                            <a href="{% url 'definir_demanda' info.rodada_ativa.id %}" class="btn btn-secondary">Definir Demanda</a>
                            <form action="{% url 'avancar_rodada' info.partida.id %}" method="post" class="action-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Processar e Avançar</button>
                            </form>
                        {% else %}
                            {% if info.jogadores.count >= 2 %}
                                <form action="{% url 'avancar_rodada' info.partida.id %}" method="post" class="action-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">Iniciar Primeira Rodada</button>
                                </form>
                                <form action="{% url 'toggle_avanco_automatico' info.partida.id %}" method="post" class="action-form">
                                    {% csrf_token %}
                                    {% if info.partida.avanco_automatico %}
                                        <button type="submit" class="btn btn-warning">Desligar Avanço Automático</button>
                                    {% else %}
                                        <button type="submit" class="btn btn-info">Ligar Avanço Automático</button>
                                    {% endif %}
                                </form>
                            {% else %}
                                <button type="button" class="btn btn-success" disabled title="É necessário ter no mínimo 2 jogadores para iniciar.">Iniciar Primeira Rodada</button>
                                <small class="text-muted d-block mt-1">Mínimo de 2 jogadores requerido.</small>
                            {% endif %}
                        {% endif %}

                        <form action="{% url 'finalizar_partida' info.partida.id %}" method="post" class="action-form" onsubmit="return confirm('Tem certeza que deseja finalizar esta partida?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Finalizar Partida</button>
                        </form>

                    {% else %}
                        <p class="text-muted">Esta partida foi concluída em {{ info.partida.data_fim|date:"d/m/Y" }}.</p>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p>Nenhuma partida criada ainda. <a href="{% url 'criar_partida' %}">Crie a primeira!</a></p>
        {% endfor %}
    </section>
</div>
{% endblock %}